<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¡æ£€è¿›åº¦ - PromAI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 2em;
            font-weight: 300;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-5px);
        }

        main {
            padding: 40px;
        }

        .task-list {
            margin-top: 30px;
        }

        .task-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .task-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .task-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .status-running {
            background: #d4edda;
            color: #155724;
        }

        .status-completed {
            background: #cce5ff;
            color: #004085;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .task-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .info-value {
            color: #333;
            font-weight: 500;
        }

        .progress-bar {
            background: #e9ecef;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 5px;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.3),
                    transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .task-log {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .log-line {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-time {
            color: #6c757d;
            margin-right: 10px;
        }

        .log-info {
            color: #17a2b8;
        }

        .log-success {
            color: #28a745;
        }

        .log-error {
            color: #dc3545;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-btn:hover {
            transform: scale(1.1) rotate(180deg);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .task-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>å·¡æ£€è¿›åº¦</h1>
            <a href="/api/promai/" class="back-btn">â† è¿”å›é¦–é¡µ</a>
        </header>

        <main>
            <div id="loadingState" class="loading" style="display: flex;">
                <div class="loading-spinner"></div>
                <p style="margin-top: 20px; color: #6c757d;">æ­£åœ¨åŠ è½½ä»»åŠ¡æ•°æ®...</p>
            </div>

            <div id="taskList" class="task-list" style="display: none;">
                <!-- ä»»åŠ¡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">ğŸ“Š</div>
                <h2>æš‚æ— è¿è¡Œä¸­çš„å·¡æ£€ä»»åŠ¡</h2>
                <p>ç‚¹å‡»"å¼€å§‹å·¡æ£€"æŒ‰é’®æ¥åˆ›å»ºæ–°çš„å·¡æ£€ä»»åŠ¡</p>
            </div>
        </main>
    </div>

    <button class="refresh-btn" onclick="fetchTasksFromBackend()" title="åˆ·æ–°">ğŸ”„</button>

    <script>
        let tasks = [];

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        function loadTasks() {
            const taskList = document.getElementById('taskList');
            const emptyState = document.getElementById('emptyState');

            // æ¸…ç©ºç°æœ‰å†…å®¹
            taskList.innerHTML = '';

            if (tasks.length === 0) {
                taskList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            taskList.style.display = 'block';
            emptyState.style.display = 'none';

            // æ¸²æŸ“æ¯ä¸ªä»»åŠ¡
            tasks.forEach(task => {
                const taskCard = createTaskCard(task);
                taskList.appendChild(taskCard);
            });
        }

        // åˆ›å»ºä»»åŠ¡å¡ç‰‡
        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'task-card';

            const statusClass = `status-${task.status}`;
            const statusText = {
                'running': 'æ‰§è¡Œä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥',
                'pending': 'ç­‰å¾…ä¸­'
            }[task.status];

            card.innerHTML = `
                <div class="task-header">
                    <div class="task-title">${task.name || 'æœªçŸ¥ä»»åŠ¡'}</div>
                    <div class="task-status ${statusClass}">${statusText}</div>
                </div>

                <div class="task-info">
                    <div class="info-item">
                        <span class="info-label">æ•°æ®æº</span>
                        <span class="info-value">${task.datasource || 'æœªçŸ¥'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å¼€å§‹æ—¶é—´</span>
                        <span class="info-value">${task.startTime ? new Date(task.startTime).toLocaleString('zh-CN') : 'æœªçŸ¥'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å·²ç”¨æ—¶é—´</span>
                        <span class="info-value">${task.startTime ? getElapsedTime(new Date(task.startTime), task.endTime, task.status) : 'æœªçŸ¥'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">è¿›åº¦</span>
                        <span class="info-value">${task.progress || 0}%</span>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${task.progress || 0}%"></div>
                </div>

                <div class="task-steps" style="margin-bottom: 15px;">
                    ${(task.steps || []).map(step => `
                        <span style="display: inline-block; margin-right: 15px; font-size: 0.9em;">
                            ${step.status === 'completed' ? 'âœ…' : step.status === 'running' ? 'â³' : 'â¸ï¸'} ${step.name}
                        </span>
                    `).join('')}
                </div>

                <div class="task-log">
                    ${(task.logs || []).map(log => `
                        <div class="log-line">
                            <span class="log-time">[${new Date(log.time).toLocaleTimeString('zh-CN')}]</span>
                            <span class="log-${log.type}">${log.message}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            return card;
        }

        // è®¡ç®—ç»è¿‡çš„æ—¶é—´
        function getElapsedTime(startTime, endTime, status) {
            // è°ƒè¯•ä¿¡æ¯
            console.log('getElapsedTimeå‚æ•°:', {
                startTime: startTime,
                endTime: endTime,
                status: status,
                startTimeType: typeof startTime,
                endTimeType: typeof endTime
            });

            let endTimeToUse = endTime;

            // å¦‚æœä»»åŠ¡ä»åœ¨è¿è¡Œä¸­ï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºç»“æŸæ—¶é—´
            if (status === 'running') {
                endTimeToUse = new Date();
            }

            // ç¡®ä¿æœ‰æœ‰æ•ˆçš„å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´
            if (!startTime || !endTimeToUse) {
                console.log('ç¼ºå°‘å¼€å§‹æ—¶é—´æˆ–ç»“æŸæ—¶é—´');
                return 'æœªçŸ¥';
            }

            // ç¡®ä¿æ˜¯Dateå¯¹è±¡
            if (!(startTime instanceof Date)) {
                startTime = new Date(startTime);
                console.log('è½¬æ¢startTimeä¸ºDateå¯¹è±¡:', startTime);
            }

            if (!(endTimeToUse instanceof Date) && endTimeToUse) {
                endTimeToUse = new Date(endTimeToUse);
                console.log('è½¬æ¢endTimeä¸ºDateå¯¹è±¡:', endTimeToUse);
            }

            const diff = endTimeToUse.getTime() - startTime.getTime();

            console.log('æ—¶é—´å·®è®¡ç®—:', {
                startTimeMs: startTime.getTime(),
                endTimeMs: endTimeToUse.getTime(),
                diff: diff,
                diffFormatted: formatDuration(diff)
            });

            // å¦‚æœæ—¶é—´å·®ä¸ºè´Ÿæ•°æˆ–å¼‚å¸¸ï¼Œè¿”å›æœªçŸ¥
            if (diff < 0) {
                console.log('æ—¶é—´å·®ä¸ºè´Ÿæ•°ï¼Œä½¿ç”¨å½“å‰æ—¶é—´');
                endTimeToUse = new Date();
                const correctedDiff = endTimeToUse.getTime() - startTime.getTime();
                return formatDurationWithStatus(correctedDiff, status);
            }

            return formatDurationWithStatus(diff, status);
        }

        // æ ¼å¼åŒ–æŒç»­æ—¶é—´
        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}åˆ†${seconds}ç§’`;
        }

        // æ ¼å¼åŒ–æŒç»­æ—¶é—´å¹¶æ·»åŠ çŠ¶æ€
        function formatDurationWithStatus(diff, status) {
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            const duration = `${minutes}åˆ†${seconds}ç§’`;

            // å¤„ç†æ—¶é—´å·®æå°çš„æƒ…å†µï¼ˆæ¯”å¦‚å°äº1ç§’ï¼‰
            if (diff < 1000) {
                if (status === 'completed') {
                    return `å·²å®Œæˆ (å°äº1ç§’)`;
                } else if (status === 'failed') {
                    return `å¤±è´¥ (å°äº1ç§’)`;
                } else {
                    return 'å°äº1ç§’';
                }
            }

            // å¦‚æœå·²å®Œæˆï¼Œæ˜¾ç¤ºå®ŒæˆçŠ¶æ€
            if (status === 'completed') {
                return `å·²å®Œæˆ (${duration})`;
            } else if (status === 'failed') {
                return `å¤±è´¥ (${duration})`;
            } else {
                return duration;
            }
        }

        // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
        function simulateProgress() {
            tasks.forEach(task => {
                if (task.status === 'running' && task.progress < 100) {
                    task.progress += Math.random() * 5;
                    if (task.progress >= 100) {
                        task.progress = 100;
                        task.status = 'completed';
                        task.log.push({
                            time: new Date().toLocaleTimeString('zh-CN'),
                            message: 'å·¡æ£€ä»»åŠ¡å®Œæˆï¼',
                            type: 'success'
                        });
                    }
                }
            });
            loadTasks();
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // ä»åç«¯è·å–å®é™…çš„ä»»åŠ¡æ•°æ®
            fetchTasksFromBackend();
        });

        // ä»åç«¯è·å–ä»»åŠ¡æ•°æ®
        function fetchTasksFromBackend() {
            const loadingState = document.getElementById('loadingState');
            const taskList = document.getElementById('taskList');
            const emptyState = document.getElementById('emptyState');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loadingState.style.display = 'flex';
            taskList.style.display = 'none';
            emptyState.style.display = 'none';

            fetch('/api/promai/tasks')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('APIè¿”å›çš„æ•°æ®:', data);
                    console.log('æ•°æ®ç±»å‹:', typeof data);
                    console.log('æ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(data));

                    // ç¡®ä¿dataæ˜¯æ•°ç»„
                    const taskArray = Array.isArray(data) ? data : (data ? [data] : []);
                    console.log('å¤„ç†åçš„ä»»åŠ¡æ•°ç»„:', taskArray);

                    tasks = taskArray.map(task => ({
                        ...task,
                        startTime: new Date(task.startTime),
                        endTime: task.endTime ? new Date(task.endTime) : null
                    }));

                    // éšè—åŠ è½½çŠ¶æ€
                    loadingState.style.display = 'none';

                    loadTasks();

                    // å¦‚æœæœ‰è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œè®¾ç½®å®šæ—¶åˆ·æ–°
                    const hasRunningTask = tasks.some(task => task.status === 'running');
                    if (hasRunningTask) {
                        // æ¸…é™¤ç°æœ‰çš„å®šæ—¶å™¨ï¼ˆé¿å…é‡å¤è®¾ç½®ï¼‰
                        if (window.progressInterval) {
                            clearInterval(window.progressInterval);
                        }
                        window.progressInterval = setInterval(() => {
                            fetchTasksFromBackend();
                        }, 2000);
                    } else {
                        // æ²¡æœ‰è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œæ¸…é™¤å®šæ—¶å™¨
                        if (window.progressInterval) {
                            clearInterval(window.progressInterval);
                            window.progressInterval = null;
                        }
                    }
                })
                .catch(error => {
                    console.error('Failed to fetch tasks:', error);
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    loadingState.style.display = 'none';
                    taskList.style.display = 'none';
                    emptyState.style.display = 'block';
                    emptyState.innerHTML = `
                        <div class="empty-state-icon">âŒ</div>
                        <h2>åŠ è½½å¤±è´¥</h2>
                        <p>æ— æ³•è·å–ä»»åŠ¡æ•°æ®ï¼š${error.message}</p>
                        <button class="create-btn" onclick="fetchTasksFromBackend()">
                            <span>ğŸ”„</span>
                            <span>é‡è¯•</span>
                        </button>
                    `;
                });
        }
    </script>
</body>

</html>